/******************************************************************************
 *	Copyright (C) 2020	Alejandro Colomar Andr√©s		      *
 *	SPDX-License-Identifier:	LGPL-2.0-only			      *
 ******************************************************************************/


/******************************************************************************
 ******* include **************************************************************
 ******************************************************************************/
#include "libalx/base/signal/sigpipe.h"

#include <signal.h>
#include <stdbool.h>
#include <stddef.h>

#include "libalx/base/compiler/unused.h"


/******************************************************************************
 ******* define ***************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* enum / struct / union ************************************************
 ******************************************************************************/


/******************************************************************************
 ******* static variables *****************************************************
 ******************************************************************************/
sig_atomic_t	alx_sigpipe;


/******************************************************************************
 ******* static prototypes ****************************************************
 ******************************************************************************/
static
void	sigpipe_handler		(int sig);


/******************************************************************************
 ******* global functions *****************************************************
 ******************************************************************************/
int	alx_sigpipe_init	(void)
{
	struct sigaction	sa = {0};

	alx_sigpipe	= false;
	asm volatile ("" : : : "memory");

	sigemptyset(&sa.sa_mask);
	sa.sa_handler	= &sigpipe_handler;
	return	sigaction(SIGPIPE, &sa, NULL);
}


/******************************************************************************
 ******* alias ****************************************************************
 ******************************************************************************/
ALX_ALIAS_WEAK_DEFINITION(sigpipe,	alx_sigpipe);
ALX_ALIAS_WEAK_DEFINITION(sigpipe_init,	alx_sigpipe_init);


/******************************************************************************
 ******* static function definitions ******************************************
 ******************************************************************************/
static
void	sigpipe_handler		(int sig)
{

	ALX_UNUSED(sig);

	alx_sigpipe	= true;
	asm volatile ("" : : : "memory");
}


/******************************************************************************
 ******* end of file **********************************************************
 ******************************************************************************/

