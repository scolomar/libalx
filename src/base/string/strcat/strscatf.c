/******************************************************************************
 *	Copyright (C) 2020	Alejandro Colomar Andr√©s		      *
 *	SPDX-License-Identifier:	LGPL-2.0-only			      *
 ******************************************************************************/


/******************************************************************************
 ******* include **************************************************************
 ******************************************************************************/
#include "libalx/base/string/strcat/strscatf.h"

#include <errno.h>
#include <stdarg.h>
#include <stddef.h>
#include <string.h>

#include "libalx/base/assert/stddef.h"
#include "libalx/base/stdio/printf/snprintfs.h"


/******************************************************************************
 ******* _Static_assert *******************************************************
 ******************************************************************************/
alx_Static_assert_size_ptrdiff();


/******************************************************************************
 ******* define ***************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* enum / struct / union ************************************************
 ******************************************************************************/


/******************************************************************************
 ******* static prototypes ****************************************************
 ******************************************************************************/


/******************************************************************************
 ******* global functions *****************************************************
 ******************************************************************************/
ptrdiff_t alx_strscatf		(ptrdiff_t size,
				 char dest[static restrict size],
				 const char *restrict format, ...)
{
	va_list		ap;
	ptrdiff_t	len;

	va_start(ap, format);
	len	= alx_vstrscatf(size, dest, format, ap);
	va_end(ap);

	return	len;
}

//#pragma GCC diagnostic push	/* Overflow is explicitly handled */
//#pragma GCC diagnostic ignored	"-Wsign-conversion"
ptrdiff_t alx_vstrscatf		(ptrdiff_t size,
				 char dest[static restrict size],
				 const char *restrict format, va_list ap)
{
	ptrdiff_t	dlen;
	ptrdiff_t	slen;

	if (size <= 0)
		return	-E2BIG;

	dlen	= strnlen(dest, size);
	if (dlen == size)
		goto err;

	if (alx_vsnprintfs(dest + dlen, &slen, size - dlen, format, ap))
		goto err;

	return	dlen + slen;
err:
	dest[dlen - 1] = '\0';
	return	-1;

}
//#pragma GCC diagnostic pop


/******************************************************************************
 ******* alias ****************************************************************
 ******************************************************************************/
ALX_ALIAS_WEAK_DEF(strscatf,	alx_strscatf);
ALX_ALIAS_WEAK_DEF(vstrscatf,	alx_vstrscatf);


/******************************************************************************
 ******* static function definitions ******************************************
 ******************************************************************************/


/******************************************************************************
 ******* end of file **********************************************************
 ******************************************************************************/
